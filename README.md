# L0: Go Kafka Postgres Demo Service

## Описание

Демонстрационный микросервис на Go, который:
- Получает данные заказов из очереди сообщений (Kafka)
- Сохраняет их в базу данных (PostgreSQL)
- Кэширует заказы в памяти для быстрого доступа
- Предоставляет HTTP API для получения заказа по ID
- Имеет простой веб-интерфейс для поиска заказа

## Структура проекта
	go-kafka-postgres/
	├── cmd/
	│   ├── producer/
	│   │   └── main.go
	│   └── server/
	│       └── main.go
	├── internal/
	│   ├── cache/
	│   │   └── cache.go
	│   ├── consumer/
	│   │   └── consumer.go
	│   ├── db/
	│   │   └── db.go
	│   ├── handler/
	│   │   └── handler.go
	│   ├── logger/
	│   │   └── logger.go
	│   └── model/
	│       └── model.go
	├── migrations/
	│   └──000001_init.up.sql
	├── web/            
	│   └── index.html
	├── .dockerignore
	├── .env                 
	├── .gitignore
	├── docker-compose.yml
	├── Dockerfile
	├── go.mod
	├── go.sum
	├── Makefile
	├── model.json  
	└── README.md
## Функциональность

- **Kafka Consumer**: подписка на топик заказов, обработка входящих сообщений, валидация, сохранение в БД и кэш.
- **PostgreSQL**: хранение заказов, доставка, оплата, товары. Используются транзакции для целостности данных.
- **Кэш**: LRU кэш для ускоренного доступа к заказам. При старте сервиса кэш восстанавливается из БД.
- **HTTP API**: эндпоинт `/order?uid=<order_uid>` возвращает заказ в формате JSON.
- **Веб-интерфейс**: страница `index.html` позволяет искать заказ по ID.
- **Docker**: сервис полностью контейнеризирован (Dockerfile, docker-compose.yml).

## Модель данных

Структура заказа соответствует [model.json](model.json):

## Makefile: автоматизация сборки и запуска

В проекте есть Makefile для удобства:

- `make build` — сборка бинарников сервиса и продюсера
- `make run` — запуск сервиса локально (без Docker)
- `make producer` — запуск эмулятора отправки заказов

> Для работы команд нужен установленный Go и доступ к PostgreSQL/Kafka (можно через Docker Compose).

## Быстрый старт

### 1. Клонируйте репозиторий

```sh
git clone <repo_url>
cd go-kafka-postgres
```

### 2. Запуск через Docker Compose

```sh
docker-compose up --build
```

Будут запущены:
- Kafka + Zookeeper
- PostgreSQL (с миграциями и нужными таблицами)
- Микросервис (app)
- Эмулятор отправки заказов (producer)

### 3. Проверка работы

- **Веб-интерфейс**: откройте [http://localhost:8081](http://localhost:8081) в браузере.
- Введите `order_uid` (например, `b563feb7b2b84b6test`) и нажмите "Найти заказ".
- Данные заказа появятся на странице.

- **HTTP API**: запрос через curl или браузер:
	```
	GET http://localhost:8081/order?uid=b563feb7b2b84b6test
	```
	Ответ — JSON с данными заказа.

### 4. Отправка тестовых заказов

Producer автоматически отправляет тестовые заказы в Kafka при запуске. Можно изменить заказ в `model.json`.

### 5. Структура проекта

- `cmd/server/main.go` — основной сервис
- `cmd/producer/main.go` — эмулятор отправки заказов
- `internal/` — бизнес-логика (db, cache, consumer, handler, logger, model)
- `web/index.html` — веб-интерфейс
- `migrations/` — SQL-миграции для БД
- `docker-compose.yml`, `Dockerfile` — контейнеризация

## Как работает сервис

1. **Инициализация**: при старте сервис подключается к БД, восстанавливает кэш заказов, запускает Kafka consumer и HTTP сервер.
2. **Получение заказа**: при запросе через API или веб-интерфейс сервис ищет заказ сначала в кэше, затем в БД.
3. **Обработка сообщений**: consumer получает сообщения из Kafka, валидирует, сохраняет в БД и кэширует.
4. **Восстановление после сбоя**: при перезапуске кэш восстанавливается из БД, данные не теряются благодаря транзакциям и подтверждению сообщений.

## Валидация и обработка ошибок

- Некорректные сообщения из Kafka игнорируются и логируются.
- Все операции с БД — в транзакциях.
- Если БД недоступна — сервис пишет ошибку в лог, не теряет данные.
- Кэш ускоряет повторные запросы по одному и тому же ID.

## Требования

- Docker, Docker Compose
- Go 1.24 (для локальной сборки)
- Свободные порты: 8081 (app), 5432 (Postgres), 9092/29092 (Kafka)

## Улучшения

- Можно добавить авторизацию, пагинацию, расширенный UI, healthchecks, CI/CD.
- Для продакшена рекомендуется использовать отдельный init-контейнер для миграций, мониторинг, алертинг.

## Лицензия

MIT
